# ragMyAdmin Permission System Phase 1 - å®Ÿè£…å®Œäº†å ±å‘Š

## ğŸ“‹ å®Ÿè£…å†…å®¹

### âœ… 1. SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
- **å ´æ‰€**: `~/rag/users.db`
- **ã‚¹ã‚­ãƒ¼ãƒ**: è¨­è¨ˆæ›¸v4é€šã‚Šã®CREATE TABLEæ–‡ã§ä½œæˆ
- **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤**: `groups='[]'`ï¼ˆç©ºJSONé…åˆ—ï¼‰
- **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: UTCçµ±ä¸€ `datetime('now', 'utc')`
- **ç›£æŸ»ãƒ­ã‚°**: user_idã‚«ãƒ©ãƒ å«ã‚€

### âœ… 2. CLIãƒ„ãƒ¼ãƒ«ä½œæˆ
- **å ´æ‰€**: `~/rag/admin/ragadmin.py`
- **ã‚³ãƒãƒ³ãƒ‰**: `useradd`, `passwd`, `roles`, `unlock`, `audit --purge`
- **adminãƒ¦ãƒ¼ã‚¶ãƒ¼**: CLIã®ã¿ã§ä½œæˆï¼ˆ`--admin`ãƒ•ãƒ©ã‚°ï¼‰
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼**: 12æ–‡å­—ä»¥ä¸Šã€è‹±å¤§å°æ–‡å­—+æ•°å­—å¿…é ˆ
- **ãƒãƒƒã‚·ãƒ¥**: bcrypt cost factor=12
- **ç›£æŸ»**: ãƒ‘ãƒ¼ã‚¸æ“ä½œã‚‚`purge_audit_log`ã¨ã—ã¦è¨˜éŒ²

### âœ… 3. Flask-Sessionå°å…¥
- **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: `flask-session`, `flask-wtf`
- **è¨­å®š**: `SESSION_TYPE='filesystem'` (`~/rag/admin/sessions/`)
- **Cookie**: HttpOnly, SameSite=Lax, 1æ™‚é–“æœ‰åŠ¹
- **CSRF**: Flask-WTFã®CSRFProtectï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ä»¥å¤–ï¼‰
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«`session.clear()`â†’æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**: `session_version`ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆæ™‚ç„¡åŠ¹åŒ–

### âœ… 4. ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
- **å ´æ‰€**: `/login` (`~/rag/admin/templates/login.html`)
- **ãƒ‡ã‚¶ã‚¤ãƒ³**: æ—¢å­˜ragMyAdminã«åˆã‚ã›ãŸãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ
- **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**: æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¼·åˆ¶ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
- **ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹å¯¾ç­–**: 
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥: 5å›/15åˆ†ã§ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
  - IPåˆ¥: 15å›/15åˆ†ã§ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆé–¾å€¤3å€ï¼‰
- **ç›£æŸ»ãƒ­ã‚°**: `login`/`login_failed`ã‚’è¨˜éŒ²
- **IPãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: `ipaddress`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§æ¤œè¨¼

### âœ… 5. Phase1æš«å®šæªç½®
- **è¨­å®š**: `PHASE2_COMPLETE = False`
- **åˆ¶é™**: adminä»¥å¤–ã¯POST/PUT/DELETEæ‹’å¦ï¼ˆæ¤œç´¢APIé™¤ãï¼‰
- **äºŒé‡é˜²å¾¡**: Apache Basicèªè¨¼ã¯æ®‹ã—ãŸã¾ã¾

### âœ… 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ç´„
- **SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³**: å…¨DBã‚¢ã‚¯ã‚»ã‚¹ã¯Parameterized Query
- **XSSå¯¾ç­–**: Jinja2ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆ`|safe`ç¦æ­¢ï¼‰
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€**: `Content-Security-Policy: default-src 'self'`

## ğŸ§ª å‹•ä½œç¢ºèªæ¸ˆã¿

### èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 
- âœ… adminãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ»ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
- âœ… viewerãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ»ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
- âœ… æœªèªè¨¼ã‚¢ã‚¯ã‚»ã‚¹æ­£ã—ããƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- âœ… ä¸æ­£ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œæ­£ã—ãæ‹’å¦

### Phase1ãƒãƒªã‚·ãƒ¼
- âœ… adminãƒ¦ãƒ¼ã‚¶ãƒ¼: å…¨æ“ä½œè¨±å¯
- âœ… viewerãƒ¦ãƒ¼ã‚¶ãƒ¼: èª­ã¿å–ã‚Šæ“ä½œè¨±å¯
- âœ… viewerãƒ¦ãƒ¼ã‚¶ãƒ¼: å¤‰æ›´æ“ä½œï¼ˆPOST/PUT/DELETEï¼‰æ­£ã—ããƒ–ãƒ­ãƒƒã‚¯ï¼ˆ403ï¼‰
- âœ… æ¤œç´¢API: viewerã«ã‚‚è¨±å¯ï¼ˆèª­ã¿å–ã‚Šæ“ä½œã¨ã—ã¦æ‰±ã„ï¼‰

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†æ­£å¸¸å‹•ä½œ
- âœ… ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹å¯¾ç­–å‹•ä½œ
- âœ… ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸãƒ»å¤±æ•—ï¼‰
- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€è¨­å®š

## ğŸ“Š ä½œæˆæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼

| ãƒ¦ãƒ¼ã‚¶ãƒ¼ | ãƒ­ãƒ¼ãƒ« | ã‚°ãƒ«ãƒ¼ãƒ— | ç”¨é€” |
|----------|--------|----------|------|
| goodsun | admin | [] | ç®¡ç†è€…ï¼ˆå…¨æ¨©é™ï¼‰ |
| testviewer | viewer | ["testgroup","viewers"] | é–²è¦§è€…ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰|

## ğŸš€ systemdã‚µãƒ¼ãƒ“ã‚¹

- **ã‚µãƒ¼ãƒ“ã‚¹**: `ragmyadmin.service`
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: `active (running)`
- **è¨­å®š**: SECRET_KEYè¿½åŠ æ¸ˆã¿
- **è‡ªå‹•èµ·å‹•**: enabled

## ğŸ“ ç›£æŸ»ãƒ­ã‚°ã‚µãƒ³ãƒ—ãƒ«

```
2026-02-23 10:25:50 | testviewer      | login                | 127.0.0.1      
2026-02-23 10:25:47 | goodsun         | login                | 127.0.0.1      
2026-02-23 10:21:16 | testviewer      | change_group         | localhost       -> testviewer
2026-02-23 10:18:37 | system          | create_user          | localhost       -> testviewer
2026-02-23 10:14:50 | system          | create_user          | localhost       -> goodsun
```

## ğŸ”§ CLIã‚³ãƒãƒ³ãƒ‰ä¾‹

```bash
# adminãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
python3 ragadmin.py useradd --admin goodsun

# é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
python3 ragadmin.py useradd testviewer

# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
python3 ragadmin.py passwd goodsun

# ãƒ­ãƒ¼ãƒ«ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—å¤‰æ›´
python3 ragadmin.py roles testviewer --groups '["testgroup","viewers"]'

# ç›£æŸ»ãƒ­ã‚°ç¢ºèª
python3 ragadmin.py audit --limit 10

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒƒã‚¯è§£é™¤
python3 ragadmin.py unlock testviewer
```

## ğŸ¯ Phase 1 å®Œäº†

ragMyAdmin Permission System Phase 1ã®å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã™ã¹ã¦ã®è¦ä»¶ãŒå®Ÿè£…ã•ã‚Œã€å‹•ä½œãƒ†ã‚¹ãƒˆã‚‚å®Œäº†ã—ã¦ã„ã¾ã™ã€‚

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: Phase 2ï¼ˆChromaDBãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¨©é™åˆ¶å¾¡ï¼‰ã®å®Ÿè£…æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

**å¤‰æ›´ä¸è¦**: æ—¢å­˜ã®ragMyAdminæ©Ÿèƒ½ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³é–²è¦§ã€æ¤œç´¢ç­‰ï¼‰ã¯ã™ã¹ã¦å‹•ä½œç¶™ç¶šã—ã¦ã„ã¾ã™ã€‚