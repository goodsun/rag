{% extends "base.html" %}
{% block title %}Documents â€” {{ name }} â€” ragMyAdmin{% endblock %}
{% block col_count %}1{% endblock %}


{% block content %}
<div class="pma-breadcrumb">
  <a href="{{ BASE }}/">Collections</a> <span>Â»</span> {{ name }}
</div>

<h2 class="pma-heading">ğŸ“° {{ name }} â€” {{ total }} documents, {{ chunk_total }} chunks</h2>

<div class="pma-notice">
  A <b>Document</b> (LogicalDocument) is a group of chunks derived from the same source.
  Grouped by ID prefix convention: <code>{document_key}_c{index}</code>
</div>

<div style="margin-bottom:8px;margin-top:8px">
  <input type="text" id="filter-input" placeholder="Filter documents..." style="padding:4px 8px;border:1px solid #aaa;border-radius:3px;font-size:12px;width:300px">
  {% if can_write %}<button class="pma-btn danger" id="delete-btn" style="display:none">ğŸ—‘ï¸ Drop selected</button>{% endif %}
</div>

<table class="pma-table" id="docs-table">
  <thead>
    <tr>
      <th style="width:25px">{% if can_write %}<input type="checkbox" id="check-all">{% endif %}</th>
      <th>#</th>
      <th>Document Key</th>
      <th>Title</th>
      <th style="text-align:center">Chunks</th>
      <th style="text-align:right">Total Chars</th>
      <th>Owner</th>
      <th>Published</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  {% for doc in documents %}
    <tr data-key="{{ doc.key }}" data-chunks="{{ doc.chunks|tojson|e }}">
      <td>{% if can_write %}<input type="checkbox" class="doc-cb" value="{{ doc.key }}">{% endif %}</td>
      <td>{{ loop.index }}</td>
      <td><a href="{{ BASE }}/collection/{{ name }}/document/{{ doc.key }}"><code>{{ doc.key }}</code></a></td>
      <td style="max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="{{ doc.title }}">
        {% if doc.url %}<a href="{{ doc.url }}" target="_blank">{{ doc.title }}</a>
        {% else %}{{ doc.title }}{% endif %}
      </td>
      <td style="text-align:center">{{ doc.chunks|length }}</td>
      <td style="text-align:right">{{ doc.total_chars }}</td>
      <td style="font-size:11px">{{ doc.owner if doc.owner else 'system' }}</td>
      <td style="font-size:11px;white-space:nowrap">{{ doc.published_at[:10] if doc.published_at else '' }}</td>
      <td style="white-space:nowrap">
        <a href="{{ BASE }}/collection/{{ name }}/document/{{ doc.key }}" class="pma-btn pma-btn-sm" title="View">ğŸ‘ï¸</a>
        {% if can_write %}
        <a href="{{ BASE }}/collection/{{ name }}/document/{{ doc.key }}/edit" class="pma-btn pma-btn-sm" title="Edit">âœï¸</a>
        <button class="pma-btn pma-btn-sm delete-doc-btn" title="Delete" data-key="{{ doc.key }}" data-chunks="{{ doc.chunks|tojson|e }}">ğŸ—‘ï¸</button>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce }}">
(function() {
  function updateDeleteBtn() {
    const n = document.querySelectorAll('.doc-cb:checked').length;
    const btn = document.getElementById('delete-btn');
    if (btn) { btn.style.display = n ? 'inline-block' : 'none'; btn.textContent = `ğŸ—‘ï¸ Drop selected (${n} documents)`; }
  }
  document.getElementById('filter-input').addEventListener('input', function() {
    const q = this.value.toLowerCase();
    document.querySelectorAll('#docs-table tbody tr').forEach(tr => {
      tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
  const checkAll = document.getElementById('check-all');
  if (checkAll) checkAll.addEventListener('change', function() {
    document.querySelectorAll('.doc-cb').forEach(cb => { cb.checked = this.checked; });
    updateDeleteBtn();
  });
  document.querySelectorAll('.doc-cb').forEach(cb => cb.addEventListener('change', updateDeleteBtn));
  const deleteBtn = document.getElementById('delete-btn');
  if (deleteBtn) deleteBtn.addEventListener('click', async function() {
    const checked = [...document.querySelectorAll('.doc-cb:checked')];
    if (!checked.length) return;
    let allIds = [];
    checked.forEach(cb => {
      const tr = cb.closest('tr');
      const chunks = JSON.parse(tr.dataset.chunks);
      allIds = allIds.concat(chunks);
    });
    if (!confirm(`Drop ${checked.length} document(s) (${allIds.length} chunks total)?`)) return;
    const resp = await fetch('{{ BASE }}/api/delete', {
      method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrf_token')},
      body: JSON.stringify({collection: '{{ name }}', ids: allIds})
    });
    const data = await resp.json();
    if (data.error) { alert(data.error); return; }
    alert(`Dropped ${data.deleted} chunks. Remaining: ${data.remaining}`);
    location.reload();
  });
  document.querySelectorAll('.delete-doc-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const key = this.dataset.key;
      const chunks = JSON.parse(this.dataset.chunks);
      if (!confirm(`Delete document "${key}" (${chunks.length} chunks)?`)) return;
      const resp = await fetch('{{ BASE }}/api/delete', {
        method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrf_token')},
        body: JSON.stringify({collection: '{{ name }}', ids: chunks})
      });
      const data = await resp.json();
      if (data.error) { alert(data.error); return; }
      alert(`Deleted ${data.deleted} chunks.`);
      location.reload();
    });
  });
})();
</script>
{% endblock %}
