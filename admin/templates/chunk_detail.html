{% extends "base.html" %}
{% block title %}{{ chunk.id }} â€” ragMyAdmin{% endblock %}
{% block col_count %}1{% endblock %}


{% block content %}
<div class="pma-breadcrumb">
  <a href="{{ BASE }}/">Collections</a> <span>Â»</span>
  <a href="{{ BASE }}/collection/{{ name }}">{{ name }}</a> <span>Â»</span>
  {% set parts = chunk.id.rsplit('_c', 1) %}
  {% if parts|length == 2 %}
    <a href="{{ BASE }}/collection/{{ name }}/document/{{ parts[0] }}">{{ parts[0] }}</a> <span>Â»</span>
    c{{ parts[1] }}
  {% else %}
    {{ chunk.id }}
  {% endif %}
</div>

<h2 class="pma-heading">ğŸ“„ Chunk: <code>{{ chunk.id }}</code></h2>

<div style="margin-bottom:12px">
  {% if can_write %}
  <button class="pma-btn danger" onclick="deleteChunk()">ğŸ—‘ï¸ Drop</button>
  {% endif %}
  {% set parts = chunk.id.rsplit('_c', 1) %}
  {% if parts|length == 2 %}
  <a href="{{ BASE }}/collection/{{ name }}/document/{{ parts[0] }}" class="pma-btn">â† Back to document</a>
  {% endif %}
  <a href="{{ BASE }}/collection/{{ name }}" class="pma-btn">â† Back to {{ name }}</a>
</div>

<h3>â„¹ï¸ Metadata</h3>
{% if chunk.metadata %}
<table class="pma-table" style="width:auto">
  {% for k, v in chunk.metadata.items()|sort %}
  <tr>
    <th{% if k.startswith('__') and k in ['__owner', '__permission', '__visibility', '__groups'] %} style="background:#e8f4f8;font-weight:bold"{% endif %}>{{ k }}</th>
    <td{% if k.startswith('__') and k in ['__owner', '__permission', '__visibility', '__groups'] %} style="background:#e8f4f8"{% endif %}>
      {% if k in ('key', '__key') and chunk.metadata.get('origin', chunk.metadata.get('__origin', '')) %}
        <a href="{{ chunk.metadata.get('origin', chunk.metadata.get('__origin', '')) }}{{ v }}" target="_blank">{{ v }}</a>
      {% elif k == '__permission' %}
        <code>{{ v }}</code>
        {% if v == '744' %}
          <span style="font-size:11px;color:#666">(owner: rwx, group: r--, other: r--)</span>
        {% elif v == '754' %}
          <span style="font-size:11px;color:#666">(owner: rwx, group: r-x, other: r--)</span>
        {% elif v == '644' %}
          <span style="font-size:11px;color:#666">(owner: rw-, group: r--, other: r--)</span>
        {% elif v == '640' %}
          <span style="font-size:11px;color:#666">(owner: rw-, group: r--, other: ---)</span>
        {% endif %}
      {% elif k == '__visibility' %}
        {% if v == 'private' %}
          <span style="color:#d63031">ğŸ”’ {{ v }}</span>
        {% else %}
          <span style="color:#00b894">ğŸŒ {{ v }}</span>
        {% endif %}
      {% elif k == '__owner' %}
        <strong>{{ v }}</strong>
      {% elif k == '__groups' %}
        {% if v and v != '[]' %}
          {{ v }}
        {% else %}
          <span style="color:#888">(no groups)</span>
        {% endif %}
      {% elif v is string and v.startswith('http') %}
        <a href="{{ v }}" target="_blank">{{ v }}</a>
      {% else %}
        {{ v }}
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>
{% else %}
<div class="pma-notice">No metadata</div>
{% endif %}

<h3>ğŸ”¢ Embedding</h3>
<div class="pma-notice">
  Dimensions: <b>{{ chunk.embedding_dim }}</b>
  {% if chunk.embedding_preview %}
  | Preview: [{{ chunk.embedding_preview|map('round', 4)|join(', ') }}, â€¦]
  {% endif %}
</div>

<h3>ğŸ“ Document Content <span style="font-weight:normal;font-size:11px;color:#888">(<span id="char-count">{{ chunk.document|length }}</span> chars)</span>
  {% if can_write %}
  <button class="pma-btn pma-btn-sm" id="edit-toggle" onclick="toggleEdit()" style="margin-left:8px">âœï¸ Edit</button>
  <button class="pma-btn pma-btn-sm" id="save-btn" onclick="saveChunk()" style="margin-left:4px;display:none">ğŸ’¾ Save</button>
  <button class="pma-btn pma-btn-sm" id="cancel-btn" onclick="cancelEdit()" style="margin-left:4px;display:none">Cancel</button>
  <span id="save-status" style="font-size:11px;color:#666;margin-left:8px"></span>
  {% else %}
  <span style="font-size:11px;color:#888;margin-left:8px">({{ user_role }} - read only)</span>
  {% endif %}
</h3>
<div class="chunk-content" id="content-view">{{ chunk.document }}</div>
<textarea id="content-edit" style="display:none;width:100%;min-height:400px;padding:12px;font-family:monospace;font-size:12px;line-height:1.7;border:2px solid #235a81;border-radius:3px;background:#fffff0;resize:vertical" oninput="document.getElementById('char-count').textContent=this.value.length">{{ chunk.document }}</textarea>

<h3 style="margin-top:16px">ğŸ” Similar Chunks</h3>
<div id="similar-results"><div class="loading">â³ Loading similar chunks...</div></div>
{% endblock %}

{% block scripts %}
<script>
let editing = false;
const origText = {{ chunk.document|tojson }};

function toggleEdit() {
  editing = true;
  document.getElementById('content-view').style.display = 'none';
  document.getElementById('content-edit').style.display = 'block';
  document.getElementById('edit-toggle').style.display = 'none';
  document.getElementById('save-btn').style.display = 'inline-block';
  document.getElementById('cancel-btn').style.display = 'inline-block';
  document.getElementById('content-edit').focus();
}
function cancelEdit() {
  editing = false;
  document.getElementById('content-view').style.display = 'block';
  document.getElementById('content-edit').style.display = 'none';
  document.getElementById('content-edit').value = origText;
  document.getElementById('edit-toggle').style.display = 'inline-block';
  document.getElementById('save-btn').style.display = 'none';
  document.getElementById('cancel-btn').style.display = 'none';
  document.getElementById('save-status').textContent = '';
  document.getElementById('char-count').textContent = origText.length;
}
async function saveChunk() {
  const newText = document.getElementById('content-edit').value;
  if (newText === origText) { cancelEdit(); return; }
  
  const status = document.getElementById('save-status');
  status.textContent = 'â³ Saving & re-embedding...';
  
  const resp = await fetch('{{ BASE }}/api/update_chunk', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({collection: '{{ name }}', id: '{{ chunk.id }}', document: newText})
  });
  const data = await resp.json();
  if (data.error) { status.textContent = 'âŒ ' + data.error; return; }
  
  status.textContent = `âœ… Saved (${data.new_length} chars, re-embedded)`;
  document.getElementById('content-view').textContent = newText;
  setTimeout(() => location.reload(), 1000);
}

async function deleteChunk() {
  if (!confirm('Delete this chunk?')) return;
  const resp = await fetch('{{ BASE }}/api/delete', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({collection: '{{ name }}', ids: ['{{ chunk.id }}']})
  });
  const data = await resp.json();
  if (data.error) { alert(data.error); return; }
  alert('Deleted.');
  location.href = '{{ BASE }}/collection/{{ name }}';
}

(async function() {
  const doc = origText;
  const resp = await fetch('{{ BASE }}/api/search', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({collection: '{{ name }}', query: doc.slice(0, 500), n_results: 6})
  });
  const data = await resp.json();
  const el = document.getElementById('similar-results');
  const results = data.results.filter(r => r.id !== '{{ chunk.id }}').slice(0, 5);
  
  if (!results.length) { el.innerHTML = '<div class="pma-notice">No similar chunks found</div>'; return; }
  
  let html = '<table class="pma-table"><thead><tr><th>Distance</th><th>Source</th><th>Preview</th><th></th></tr></thead><tbody>';
  results.forEach(r => {
    html += `<tr>
      <td><span class="distance">${r.distance}</span></td>
      <td style="font-size:11px">${escHtml(r.metadata?.document_title || r.metadata?.article_title || r.metadata?.title || r.id)}</td>
      <td class="truncate">${escHtml(r.document.slice(0, 150))}</td>
      <td><a href="${BASE}/collection/{{ name }}/chunk/${encodeURIComponent(r.id)}" class="pma-btn pma-btn-sm">View</a></td>
    </tr>`;
  });
  html += '</tbody></table>';
  el.innerHTML = html;
})();

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
</script>
{% endblock %}
