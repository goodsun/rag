{% extends "base.html" %}
{% block title %}{{ chunk.id }} ‚Äî ragMyAdmin{% endblock %}
{% block col_count %}1{% endblock %}


{% block content %}
<div class="pma-breadcrumb">
  <a href="{{ BASE }}/">Collections</a> <span>¬ª</span>
  <a href="{{ BASE }}/collection/{{ name }}">{{ name }}</a> <span>¬ª</span>
  {% set parts = chunk.id.rsplit('_c', 1) %}
  {% if parts|length == 2 %}
    <a href="{{ BASE }}/collection/{{ name }}/document/{{ parts[0] }}">{{ parts[0] }}</a> <span>¬ª</span>
    c{{ parts[1] }}
  {% else %}
    {{ chunk.id }}
  {% endif %}
</div>

<h2 class="pma-heading">üìÑ Chunk: <code>{{ chunk.id }}</code></h2>

<div style="margin-bottom:12px">
  {% if can_write %}
  <button class="pma-btn danger" id="delete-chunk-btn">üóëÔ∏è Drop</button>
  {% endif %}
  {% set parts = chunk.id.rsplit('_c', 1) %}
  {% if parts|length == 2 %}
  <a href="{{ BASE }}/collection/{{ name }}/document/{{ parts[0] }}" class="pma-btn">‚Üê Back to document</a>
  {% endif %}
  <a href="{{ BASE }}/collection/{{ name }}" class="pma-btn">‚Üê Back to {{ name }}</a>
</div>

<h3>‚ÑπÔ∏è Metadata</h3>
{% if chunk.metadata %}
<table class="pma-table" style="width:auto">
  {% for k, v in chunk.metadata.items()|sort %}
  <tr>
    <th{% if k.startswith('__') and k in ['__owner', '__permission', '__visibility', '__groups'] %} style="background:#e8f4f8;font-weight:bold"{% endif %}>{{ k }}</th>
    <td{% if k.startswith('__') and k in ['__owner', '__permission', '__visibility', '__groups'] %} style="background:#e8f4f8"{% endif %}>
      {% if k in ('key', '__key') and chunk.metadata.get('origin', chunk.metadata.get('__origin', '')) %}
        <a href="{{ chunk.metadata.get('origin', chunk.metadata.get('__origin', '')) }}{{ v }}" target="_blank">{{ v }}</a>
      {% elif k == '__permission' %}
        <code>{{ v }}</code>
        {% if v == '744' %}
          <span style="font-size:11px;color:#666">(owner: rwx, group: r--, other: r--)</span>
        {% elif v == '754' %}
          <span style="font-size:11px;color:#666">(owner: rwx, group: r-x, other: r--)</span>
        {% elif v == '644' %}
          <span style="font-size:11px;color:#666">(owner: rw-, group: r--, other: r--)</span>
        {% elif v == '640' %}
          <span style="font-size:11px;color:#666">(owner: rw-, group: r--, other: ---)</span>
        {% endif %}
      {% elif k == '__visibility' %}
        {% if v == 'private' %}
          <span style="color:#d63031">üîí {{ v }}</span>
        {% else %}
          <span style="color:#00b894">üåê {{ v }}</span>
        {% endif %}
      {% elif k == '__owner' %}
        <strong>{{ v }}</strong>
      {% elif k == '__groups' %}
        {% if v and v != '[]' %}
          {{ v }}
        {% else %}
          <span style="color:#888">(no groups)</span>
        {% endif %}
      {% elif v is string and v.startswith('http') %}
        <a href="{{ v }}" target="_blank">{{ v }}</a>
      {% else %}
        {{ v }}
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>
{% else %}
<div class="pma-notice">No metadata</div>
{% endif %}

<h3>üî¢ Embedding</h3>
<div class="pma-notice">
  Dimensions: <b>{{ chunk.embedding_dim }}</b>
  {% if chunk.embedding_preview %}
  | Preview: [{{ chunk.embedding_preview|map('round', 4)|join(', ') }}, ‚Ä¶]
  {% endif %}
</div>

<h3>üìù Document Content <span style="font-weight:normal;font-size:11px;color:#888">(<span id="char-count">{{ chunk.document|length }}</span> chars)</span>
  {% if can_write %}
  <button class="pma-btn pma-btn-sm" id="edit-toggle" style="margin-left:8px">‚úèÔ∏è Edit</button>
  <button class="pma-btn pma-btn-sm" id="save-btn" style="margin-left:4px;display:none">üíæ Save</button>
  <button class="pma-btn pma-btn-sm" id="cancel-btn" style="margin-left:4px;display:none">Cancel</button>
  <span id="save-status" style="font-size:11px;color:#666;margin-left:8px"></span>
  {% else %}
  <span style="font-size:11px;color:#888;margin-left:8px">({{ user_role }} - read only)</span>
  {% endif %}
</h3>
<div class="chunk-content" id="content-view">{{ chunk.document }}</div>
{% if can_write %}
<textarea id="content-edit" style="display:none;width:100%;min-height:400px;padding:12px;font-family:monospace;font-size:12px;line-height:1.7;border:2px solid #235a81;border-radius:3px;background:#fffff0;resize:vertical">{{ chunk.document }}</textarea>
{% endif %}

<h3 style="margin-top:16px">üîç Similar Chunks</h3>
<div id="similar-results"><div class="loading">‚è≥ Loading similar chunks...</div></div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce }}">
(function() {
let editing = false;
const origText = {{ chunk.document|tojson }};

const editToggle = document.getElementById('edit-toggle');
const saveBtn = document.getElementById('save-btn');
const cancelBtn = document.getElementById('cancel-btn');
const contentView = document.getElementById('content-view');
const contentEdit = document.getElementById('content-edit');
const charCount = document.getElementById('char-count');
const saveStatus = document.getElementById('save-status');

if (contentEdit) {
  contentEdit.addEventListener('input', function() { charCount.textContent = this.value.length; });
}

if (editToggle) editToggle.addEventListener('click', function() {
  editing = true;
  contentView.style.display = 'none';
  contentEdit.style.display = 'block';
  editToggle.style.display = 'none';
  saveBtn.style.display = 'inline-block';
  cancelBtn.style.display = 'inline-block';
  contentEdit.focus();
});

if (cancelBtn) cancelBtn.addEventListener('click', function() {
  editing = false;
  contentView.style.display = 'block';
  contentEdit.style.display = 'none';
  contentEdit.value = origText;
  editToggle.style.display = 'inline-block';
  saveBtn.style.display = 'none';
  cancelBtn.style.display = 'none';
  saveStatus.textContent = '';
  charCount.textContent = origText.length;
});

if (saveBtn) saveBtn.addEventListener('click', async function() {
  const newText = contentEdit.value;
  if (newText === origText) { cancelBtn.click(); return; }
  saveStatus.textContent = '‚è≥ Saving & re-embedding...';
  const resp = await fetch('{{ BASE }}/api/update_chunk', {
    method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrf_token')},
    body: JSON.stringify({collection: '{{ name }}', id: '{{ chunk.id }}', document: newText})
  });
  const data = await resp.json();
  if (data.error) { saveStatus.textContent = '‚ùå ' + data.error; return; }
  saveStatus.textContent = `‚úÖ Saved (${data.new_length} chars, re-embedded)`;
  contentView.textContent = newText;
  setTimeout(function() { location.reload(); }, 1000);
});

const deleteBtn = document.getElementById('delete-chunk-btn');
if (deleteBtn) deleteBtn.addEventListener('click', async function() {
  if (!confirm('Delete this chunk?')) return;
  const resp = await fetch('{{ BASE }}/api/delete', {
    method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrf_token')},
    body: JSON.stringify({collection: '{{ name }}', ids: ['{{ chunk.id }}']})
  });
  const data = await resp.json();
  if (data.error) { alert(data.error); return; }
  alert('Deleted.');
  location.href = '{{ BASE }}/collection/{{ name }}';
});

// Similar chunks
(async function() {
  const doc = origText;
  const resp = await fetch('{{ BASE }}/api/search', {
    method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrf_token')},
    body: JSON.stringify({collection: '{{ name }}', query: doc.slice(0, 500), n_results: 6})
  });
  const data = await resp.json();
  const el = document.getElementById('similar-results');
  const results = data.results.filter(function(r) { return r.id !== '{{ chunk.id }}'; }).slice(0, 5);

  if (!results.length) { el.innerHTML = '<div class="pma-notice">No similar chunks found</div>'; return; }

  let html = '<table class="pma-table"><thead><tr><th>Distance</th><th>Source</th><th>Preview</th><th></th></tr></thead><tbody>';
  results.forEach(function(r) {
    html += '<tr>' +
      '<td><span class="distance">' + r.distance + '</span></td>' +
      '<td style="font-size:11px">' + escHtml(r.metadata?.document_title || r.metadata?.article_title || r.metadata?.title || r.id) + '</td>' +
      '<td class="truncate">' + escHtml(r.document.slice(0, 150)) + '</td>' +
      '<td><a href="' + BASE + '/collection/{{ name }}/chunk/' + encodeURIComponent(r.id) + '" class="pma-btn pma-btn-sm">View</a></td>' +
    '</tr>';
  });
  html += '</tbody></table>';
  el.innerHTML = html;
})();

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
})();
</script>
{% endblock %}
