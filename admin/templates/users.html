{% extends "base.html" %}

{% block title %}Users - ragMyAdmin{% endblock %}

{% block col_count %}{{ users|length }}{% endblock %}

{% block content %}
<div class="pma-breadcrumb">
  <a href="{{ BASE }}/">üè† Home</a>
  <span>‚Ä∫</span> 
  üë• Users
</div>

<h2 class="pma-heading">üë• User Management</h2>

<div style="margin-bottom: 12px;">
  <a href="{{ BASE }}/users/add" class="pma-btn">‚ûï Add User</a>
</div>

{% if users %}
<table class="pma-table">
  <thead>
    <tr>
      <th>Username</th>
      <th>Role</th>
      <th>Groups</th>
      <th>Created</th>
      <th>Updated</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for user in users %}
    <tr>
      <td>
        <strong>{{ user.username }}</strong>
        {% if user.username == current_user %}
          <span style="color: #e87d0d; font-size: 10px;">(YOU)</span>
        {% endif %}
      </td>
      <td>
        <select class="role-select" data-user-id="{{ user.id }}" 
                {% if user.username == current_user %}disabled title="Cannot change your own role"{% endif %}>
          <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
          <option value="editor" {% if user.role == 'editor' %}selected{% endif %}>Editor</option>
          <option value="viewer" {% if user.role == 'viewer' %}selected{% endif %}>Viewer</option>
        </select>
      </td>
      <td>
        <input type="text" class="groups-input" data-user-id="{{ user.id }}" 
               value="{% if user.groups_list %}{{ user.groups_list|join(', ') }}{% endif %}"
               placeholder="group1, group2" style="width: 150px; font-size: 11px; padding: 2px 4px;">
        <button class="pma-btn pma-btn-sm save-groups-btn" data-user-id="{{ user.id }}">Save</button>
      </td>
      <td style="font-size: 11px; color: #666;">{{ user.created_at }}</td>
      <td style="font-size: 11px; color: #666;">{{ user.updated_at }}</td>
      <td>
        <button class="pma-btn pma-btn-sm change-pw-btn" data-user-id="{{ user.id }}" data-username="{{ user.username }}">üîë Password</button>
        {% if user.username != current_user %}
        <button class="pma-btn pma-btn-sm danger delete-user-btn" data-user-id="{{ user.id }}" data-username="{{ user.username }}">üóë Delete</button>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="empty">„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ</div>
{% endif %}

<!-- Password change modal -->
<div id="passwordModal" class="pw-modal-hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; border-radius: 5px; min-width: 400px; max-width: 90vw; max-height: 90vh; overflow-y: auto;">
    <style nonce="{{ csp_nonce }}">
      .pw-modal-hidden { display: none !important; }
      @media (max-width: 768px) {
        #passwordModal > div {
          min-width: 320px !important;
          padding: 16px !important;
          margin: 10px !important;
        }
      }
    </style>
    <h3>Change Password for <span id="modalUsername"></span></h3>
    <div style="margin: 10px 0;">
      <label>New Password:</label><br>
      <input type="password" id="newPassword" style="width: 100%; padding: 8px; margin-top: 4px;" placeholder="12+ characters, mixed case + numbers" autocomplete="new-password">
    </div>
    <div style="margin: 10px 0;">
      <label>Confirm Password:</label><br>
      <input type="password" id="confirmPassword" style="width: 100%; padding: 8px; margin-top: 4px;" autocomplete="new-password">
    </div>
    <div id="passwordError" style="color: red; margin: 10px 0; display: none;"></div>
    <div style="text-align: right; margin-top: 15px;">
      <button id="cancelPwBtn" class="pma-btn">Cancel</button>
      <button id="submitPwBtn" class="pma-btn" style="margin-left: 10px;">Change Password</button>
    </div>
  </div>
</div>

<script nonce="{{ csp_nonce }}">
(function() {
let currentUserId = null;

// Role change handler
document.querySelectorAll('.role-select').forEach(function(select) {
  select.dataset.oldValue = select.value;
  select.addEventListener('change', async function() {
    const userId = this.dataset.userId;
    const newRole = this.value;
    const oldValue = this.dataset.oldValue;

    if (!confirm('„É≠„Éº„É´„Çí„Äå' + newRole + '„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü')) {
      this.value = oldValue;
      return;
    }

    try {
      const response = await fetch(BASE + '/api/user/' + userId + '/role', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: newRole })
      });
      const result = await response.json();
      if (result.success) {
        alert(result.message);
        this.dataset.oldValue = newRole;
      } else {
        alert('„Ç®„É©„Éº: ' + result.message);
        this.value = oldValue;
      }
    } catch (error) {
      alert('„Ç®„É©„Éº: ' + error.message);
      this.value = oldValue;
    }
  });
});

// Groups save
document.querySelectorAll('.save-groups-btn').forEach(function(btn) {
  btn.addEventListener('click', async function() {
    const userId = this.dataset.userId;
    const input = document.querySelector('.groups-input[data-user-id="' + userId + '"]');
    try {
      const response = await fetch(BASE + '/api/user/' + userId + '/groups', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ groups: input.value.trim() })
      });
      const result = await response.json();
      alert(result.success ? result.message : '„Ç®„É©„Éº: ' + result.message);
    } catch (error) {
      alert('„Ç®„É©„Éº: ' + error.message);
    }
  });
});

// Password change
function openPasswordModal(userId, username) {
  currentUserId = userId;
  document.getElementById('modalUsername').textContent = username;
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmPassword').value = '';
  document.getElementById('passwordError').style.display = 'none';
  document.getElementById('passwordModal').classList.remove('pw-modal-hidden');
}

function closePasswordModal() {
  document.getElementById('passwordModal').classList.add('pw-modal-hidden');
  currentUserId = null;
}

document.querySelectorAll('.change-pw-btn').forEach(function(btn) {
  btn.addEventListener('click', function() { openPasswordModal(this.dataset.userId, this.dataset.username); });
});

document.getElementById('cancelPwBtn').addEventListener('click', closePasswordModal);

document.getElementById('submitPwBtn').addEventListener('click', async function() {
  const newPassword = document.getElementById('newPassword').value.trim();
  const confirmPassword = document.getElementById('confirmPassword').value.trim();
  const errorDiv = document.getElementById('passwordError');

  if (!newPassword) { errorDiv.textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØÂøÖÈ†à„Åß„Åô'; errorDiv.style.display = 'block'; return; }
  if (newPassword !== confirmPassword) { errorDiv.textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì'; errorDiv.style.display = 'block'; return; }
  if (newPassword.length < 12) { errorDiv.textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ12ÊñáÂ≠ó‰ª•‰∏äÂøÖË¶Å„Åß„Åô'; errorDiv.style.display = 'block'; return; }
  if (!/[a-z]/.test(newPassword) || !/[A-Z]/.test(newPassword) || !/[0-9]/.test(newPassword)) {
    errorDiv.textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„Å´„ÅØÂ∞èÊñáÂ≠ó„ÄÅÂ§ßÊñáÂ≠ó„ÄÅÊï∞Â≠ó„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ'; errorDiv.style.display = 'block'; return;
  }

  try {
    const response = await fetch(BASE + '/api/user/' + currentUserId + '/password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: newPassword })
    });
    const result = await response.json();
    if (result.success) { alert(result.message); closePasswordModal(); }
    else { errorDiv.textContent = result.message; errorDiv.style.display = 'block'; }
  } catch (error) {
    errorDiv.textContent = 'Error: ' + error.message; errorDiv.style.display = 'block';
  }
});

// Delete user
document.querySelectorAll('.delete-user-btn').forEach(function(btn) {
  btn.addEventListener('click', async function() {
    const userId = this.dataset.userId;
    const username = this.dataset.username;
    if (!confirm('„É¶„Éº„Ç∂„Éº„Äå' + username + '„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) return;
    try {
      const response = await fetch(BASE + '/api/user/' + userId + '/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const result = await response.json();
      if (result.success) { alert(result.message); location.reload(); }
      else { alert('„Ç®„É©„Éº: ' + result.message); }
    } catch (error) {
      alert('„Ç®„É©„Éº: ' + error.message);
    }
  });
});

// ESC key to close modal
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && !document.getElementById('passwordModal').classList.contains('pw-modal-hidden')) closePasswordModal();
});
})();
</script>
{% endblock %}
