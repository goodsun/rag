{% extends "base.html" %}
{% block title %}{{ name }} â€” ragMyAdmin{% endblock %}
{% block col_count %}1{% endblock %}


{% block content %}
<div class="pma-breadcrumb">
  <a href="{{ BASE }}/">Collections</a> <span>Â»</span>
  <a href="{{ BASE }}/collection/{{ name }}">{{ name }}</a>
  {% if doc_key is defined and doc_key %} <span>Â»</span> {{ doc_key }}{% endif %}
</div>

<h2 class="pma-heading">ğŸ“‹ {% if doc_title is defined and doc_title %}{{ doc_title }}{% else %}{{ name }}{% endif %} ({{ total }} chunks)</h2>

<div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
  <input type="text" id="filter-input" placeholder="Filter rows..." oninput="filterRows()" style="padding:4px 8px;border:1px solid #aaa;border-radius:3px;font-size:12px;width:250px">
  <button class="pma-btn danger" id="delete-btn" style="display:none" onclick="deleteSelected()">ğŸ—‘ï¸ Delete selected</button>
  {% if doc_key is defined and doc_key %}
  <a href="{{ BASE }}/collection/{{ name }}/document/{{ doc_key }}/edit" class="pma-btn pma-btn-sm" style="margin-left:auto">âœï¸ Edit Document</a>
  {% endif %}
</div>

<table class="pma-table" id="chunks-table">
  <thead>
    <tr>
      <th style="width:25px"><input type="checkbox" onchange="toggleAll(this)" title="Check all"></th>
      <th>ID</th>
      <th>Title</th>
      <th>Document (preview)</th>
      <th>Length</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  {% for chunk in chunks %}
    <tr data-id="{{ chunk.id }}">
      <td><input type="checkbox" class="chunk-cb" value="{{ chunk.id }}" onchange="updateDeleteBtn()"></td>
      <td><a href="{{ BASE }}/collection/{{ name }}/chunk/{{ chunk.id }}">{% if '_' in chunk.id %}{{ chunk.id.split('_')[-1] }}{% else %}{{ chunk.id[:35] }}{% endif %}</a></td>
      <td style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:11px" title="{{ chunk.title }}">{% if chunk.url %}<a href="{{ chunk.url }}" target="_blank">{{ chunk.title }}</a>{% else %}{{ chunk.title }}{% endif %}</td>
      <td style="max-width:400px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="{{ chunk.document }}">{{ chunk.document }}</td>
      <td style="text-align:right">{{ chunk.full_document|length }}</td>
      <td style="white-space:nowrap">
        <a href="{{ BASE }}/collection/{{ name }}/chunk/{{ chunk.id }}" class="pma-btn pma-btn-sm" title="Edit">âœï¸</a>
        <button class="pma-btn pma-btn-sm" title="Delete" onclick="deleteSingle('{{ chunk.id }}')">ğŸ—‘ï¸</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

{% if total_pages is defined and total_pages > 1 %}
<div class="pma-pagination">
  {% if page > 1 %}<a href="?page={{ page-1 }}&per_page={{ per_page }}">Â« Prev</a>{% endif %}
  {% for p in range(1, total_pages+1) %}
    {% if p == page %}
      <span class="current">{{ p }}</span>
    {% elif p <= 3 or p >= total_pages-2 or (p >= page-2 and p <= page+2) %}
      <a href="?page={{ p }}&per_page={{ per_page }}">{{ p }}</a>
    {% elif p == 4 or p == total_pages-3 %}
      <span style="color:#999">â€¦</span>
    {% endif %}
  {% endfor %}
  {% if page < total_pages %}<a href="?page={{ page+1 }}&per_page={{ per_page }}">Next Â»</a>{% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
async function deleteSingle(id) {
  if (!confirm(`Delete chunk "${id}"?`)) return;
  const resp = await fetch('{{ BASE }}/api/delete', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({collection: '{{ name }}', ids: [id]})
  });
  const data = await resp.json();
  if (data.error) { alert(data.error); return; }
  location.reload();
}
function toggleAll(el) {
  document.querySelectorAll('.chunk-cb').forEach(cb => { cb.checked = el.checked; });
  updateDeleteBtn();
}
function updateDeleteBtn() {
  const n = document.querySelectorAll('.chunk-cb:checked').length;
  const btn = document.getElementById('delete-btn');
  btn.style.display = n ? 'inline-block' : 'none';
  btn.textContent = `ğŸ—‘ï¸ Delete selected (${n})`;
}
async function deleteSelected() {
  const ids = [...document.querySelectorAll('.chunk-cb:checked')].map(cb => cb.value);
  if (!ids.length) return;
  if (!confirm(`Delete ${ids.length} chunk(s)?`)) return;
  const resp = await fetch('{{ BASE }}/api/delete', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({collection: '{{ name }}', ids})
  });
  const data = await resp.json();
  if (data.error) { alert(data.error); return; }
  alert(`Deleted ${data.deleted} chunk(s). Remaining: ${data.remaining}`);
  location.reload();
}
function filterRows() {
  const q = document.getElementById('filter-input').value.toLowerCase();
  document.querySelectorAll('#chunks-table tbody tr').forEach(tr => {
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}
</script>
{% endblock %}
