{% extends "base.html" %}
{% block title %}ragMyAdmin ‚Äî Dashboard{% endblock %}
{% block col_count %}{{ collections|length }}{% endblock %}
{% block sidebar %}
  {% for col in collections %}
  <li><a href="{{ BASE }}/collection/{{ col.name }}"><span class="col-icon">üì¶</span> {{ col.name }}</a></li>
  {% endfor %}
{% endblock %}

{% block content %}
<div class="pma-breadcrumb">
  üè† Collections
</div>

<h2 class="pma-heading">üìä General Settings</h2>
<div class="pma-notice">
  pgvector running. {{ collections|length }} collection(s) with {{ collections|sum(attribute='count') }} total chunks.
</div>

<table class="pma-table">
  <thead><tr><th></th><th>Collection</th><th>Documents</th><th>Chunks</th><th>Action</th></tr></thead>
  <tbody>
  {% for col in collections %}
  <tr>
    <td style="text-align:center">üì¶</td>
    <td><a href="{{ BASE }}/collection/{{ col.name }}"><b>{{ col.name }}</b></a></td>
    <td>{{ col.doc_count }}</td>
    <td>{{ col.count }}</td>
    <td>
      <a href="{{ BASE }}/collection/{{ col.name }}" class="pma-btn pma-btn-sm">üì∞ Browse</a>
      <button class="pma-btn pma-btn-sm stats-btn" data-col="{{ col.name }}">üìä Stats</button>
      <a href="#search" class="pma-btn pma-btn-sm search-focus-btn">üîç Search</a>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>

<h2 class="pma-heading" id="search">üîç Query (Semantic Search)</h2>
<div class="pma-search">
  <select id="search-col">
    {% for col in collections %}
    <option value="{{ col.name }}">{{ col.name }}</option>
    {% endfor %}
  </select>
  <input type="text" id="search-query" placeholder="Search query...">
  <label style="font-size:11px;color:#666;display:flex;align-items:center;gap:2px">n=<input type="number" id="search-n" value="10" min="1" max="50"></label>
  <button class="pma-btn" id="search-go-btn">üîç Go</button>
</div>
<div id="search-results"></div>

<div id="stats-panel" style="display:none">
  <h2 class="pma-heading">üìä Statistics: <span id="stats-name"></span></h2>
  <div id="stats-content"></div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce }}">
(function() {
async function doSearch() {
  const query = document.getElementById('search-query').value.trim();
  if (!query) return;
  const col = document.getElementById('search-col').value;
  const n = document.getElementById('search-n').value;
  const el = document.getElementById('search-results');
  el.innerHTML = '<div class="loading">‚è≥ Searching...</div>';

  const resp = await fetch(BASE + '/api/search', {
    method: 'POST',
    headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrf_token')},
    body: JSON.stringify({collection: col, query: query, n_results: n})
  });
  const data = await resp.json();

  if (!data.results.length) {
    el.innerHTML = '<div class="pma-notice">No results found.</div>';
    return;
  }

  let html = '<div class="pma-success">' + data.results.length + ' results for "<b>' + escHtml(query) + '</b>"</div>';
  html += '<table class="pma-table"><thead><tr><th>#</th><th>Distance</th><th>Source</th><th>Document</th><th></th></tr></thead><tbody>';
  data.results.forEach(function(r, i) {
    html += '<tr>' +
      '<td>' + (i+1) + '</td>' +
      '<td><span class="distance">' + r.distance + '</span></td>' +
      '<td style="font-size:11px">' + escHtml(r.metadata?.document_title || r.metadata?.article_title || r.metadata?.title || r.id) + '</td>' +
      '<td class="truncate">' + escHtml(r.document.slice(0, 200)) + '</td>' +
      '<td><a href="' + BASE + '/collection/' + col + '/chunk/' + encodeURIComponent(r.id) + '" class="pma-btn pma-btn-sm">Detail</a></td>' +
    '</tr>';
  });
  html += '</tbody></table>';
  el.innerHTML = html;
}

document.getElementById('search-go-btn').addEventListener('click', doSearch);
document.getElementById('search-query').addEventListener('keydown', function(e) { if (e.key === 'Enter') doSearch(); });
document.querySelectorAll('.search-focus-btn').forEach(function(btn) {
  btn.addEventListener('click', function() { document.getElementById('search-query').focus(); });
});

async function loadStats(name) {
  const panel = document.getElementById('stats-panel');
  const content = document.getElementById('stats-content');
  document.getElementById('stats-name').textContent = name;
  panel.style.display = 'block';
  content.innerHTML = '<div class="loading">‚è≥ Loading...</div>';

  const resp = await fetch(BASE + '/api/stats/' + name);
  const data = await resp.json();

  const maxCount = Math.max(...Object.values(data.sources));
  const dl = data.doc_lengths || {};
  const rolesResp = await fetch(BASE + '/api/roles/' + name);
  const roles = await rolesResp.json();
  const rolesHtml = Object.entries(roles).filter(function(e) { return e[1]; }).map(function(e) { return '<code>' + e[0] + ' ‚Üí ' + e[1] + '</code>'; }).join(' ');

  let html = '<div class="pma-notice">' +
    '<b>' + data.count + '</b> chunks | <b>' + data.metadata_keys.length + '</b> metadata keys | <b>' + Object.keys(data.sources).length + '</b> sources<br>' +
    'Keys: ' + data.metadata_keys.map(function(k) { return '<code>' + k + '</code>'; }).join(' ');
  if (dl.avg) html += '<br>üìè Chunk length: min <b>' + dl.min + '</b> / avg <b>' + dl.avg + '</b> / median <b>' + dl.median + '</b> / max <b>' + dl.max + '</b> chars | Total: <b>' + (dl.total_chars/1000).toFixed(0) + 'K</b> chars';
  if (rolesHtml) html += '<br>üîç Auto-detected roles: ' + rolesHtml;
  html += '</div><h3>üìÑ Source Distribution (Top 30)</h3>';
  Object.entries(data.sources).forEach(function(e) {
    html += '<div class="source-bar"><div class="name" title="' + escHtml(e[0]) + '">' + escHtml(e[0]) + '</div><div class="bar" style="width:' + Math.max(e[1]/maxCount*200, 3) + 'px"></div><div class="count">' + e[1] + '</div></div>';
  });
  content.innerHTML = html;
  panel.scrollIntoView({behavior:'smooth'});
}

document.querySelectorAll('.stats-btn').forEach(function(btn) {
  btn.addEventListener('click', function() { loadStats(this.dataset.col); });
});

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
})();
</script>
{% endblock %}
