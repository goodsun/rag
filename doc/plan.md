# RAG構築計画書

## 概要

goodsunさんのnote記事（約90本）をベクトルDB化し、テディおよび各サービスから検索・引用できるようにする。

## 目的

- goodsunさんの思想・知見をテディが理解し、文脈に沿った回答ができるようにする
- /service/ チャットボットで外部の人にも記事の内容を伝えられるようにする
- X自動エンゲージメントでgoodsunさんの視点を反映したコメント生成

## ディレクトリ構成

```
/home/ec2-user/rag/
├── doc/
│   └── plan.md              ← 本ファイル
├── data/
│   ├── raw/                 ← スクレイピングした元記事（JSON）
│   └── chunks/              ← チャンク分割済みデータ（JSON）
├── chroma_db/               ← ChromaDB永続化ディレクトリ
├── scripts/
│   ├── scrape_note.py       ← noteスクレイピング
│   ├── chunker.py           ← チャンク分割
│   └── embed.py             ← Embedding生成 + ChromaDB格納
└── config.json              ← 設定（カテゴリ定義、チャンクサイズ等）
```

## 技術スタック

| 層 | 選択 | 理由 |
|---|---|---|
| Embedding | `intfloat/multilingual-e5-small` (sentence-transformers) | 日本語対応、ローカル動作、コスト0 |
| ベクトルDB | ChromaDB | Python ネイティブ、軽量、永続化対応、pip一発 |
| チャンク分割 | 500〜800文字/チャンク | note記事のセクション単位が自然 |
| API | 既存FastAPI (`/service/api.py`) に追加 | 新サービス不要 |

## 記事カテゴリ（想定）

| カテゴリ | 記事数(概算) | チャンク数(概算) |
|---|---|---|
| 法華経シリーズ | 〜33本 | 〜33チャンク〜 |
| 牧口常三郎 | 〜14本 | 〜14チャンク〜 |
| 教育提言 | 〜14本 | 〜14チャンク〜 |
| 煩悩駆動開発 | 〜9本 | 〜9チャンク〜 |
| その他 | 〜20本 | 〜28チャンク〜 |

※ チャンク数は記事の長さにより変動

## フェーズ計画

### Phase 1: データ準備

1. **noteスクレイピング** — 全記事のタイトル・本文・URL・公開日を取得
2. **チャンク分割** — セクション単位で500〜800文字に分割、メタデータ（カテゴリ、記事タイトル、URL）付与
3. **Embedding生成** — multilingual-e5-small でベクトル化
4. **ChromaDB格納** — 永続化ディレクトリに保存

### Phase 2: テディ連携

- テディのメインセッションからRAG検索できるスキルまたはツールを追加
- `POST /api/search` エンドポイントを既存FastAPIに実装
- テディがgoodsunさんの質問に記事を引用して回答できるようにする

### Phase 3: /service/ チャットボット連携

- 外部ユーザーの質問に対しRAG検索結果をコンテキストとして付与
- OpenClawへのリクエスト時にシステムプロンプトへ関連チャンクを注入

### Phase 4: X自動エンゲージメント連携

- 自動エンゲージメント時にトピックに関連する記事チャンクを検索
- goodsunさんの視点を反映したコメント生成に活用

## コスト

- ChromaDB: 無料（ローカル）
- Embedding: 無料（ローカルモデル）
- 追加サーバー: 不要（現EC2で動作）
- 追加ストレージ: 数十MB程度（ベクトルDB + モデルキャッシュ）

## 更新運用

- 新記事追加時: スクレイピング → チャンク分割 → Embedding → DB追加
- 将来的にはcronで定期的に新記事を検出・追加する仕組みも検討
